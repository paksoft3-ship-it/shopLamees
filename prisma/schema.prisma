// ─── Prisma Schema — Shop Lamees ───────────────────────────────────

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ──────────────────────────────────────────────────────────

enum OrderStatus {
  NEW
  PROCESSING
  SHIPPED
  COMPLETED
  CANCELLED
}

enum Currency {
  QAR
  SAR
}

enum Country {
  QA
  SA
}

enum AdminRole {
  OWNER
  STAFF
}

// ─── Catalog ────────────────────────────────────────────────────────

model Category {
  id        String   @id @default(cuid())
  slug      String   @unique
  nameAr    String
  nameEn    String
  image     String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  products ProductCategory[]

  @@map("categories")
}

model Product {
  id           String   @id @default(cuid())
  slug         String   @unique
  titleAr      String
  titleEn      String
  descAr       String?
  descEn       String?
  badgeAr      String?
  badgeEn      String?
  fabric       String?
  color        String?
  rating       Float    @default(0)
  isBestSeller Boolean  @default(false)
  isPublished  Boolean  @default(true)
  isCustom     Boolean  @default(false)
  madeToOrder  Boolean  @default(false)
  leadTimeDays Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  images     ProductImage[]
  variants   ProductVariant[]
  categories ProductCategory[]
  orderItems OrderItem[]

  @@map("products")
}

model ProductCategory {
  productId  String
  categoryId String

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@map("product_categories")
}

model ProductImage {
  id        String @id @default(cuid())
  productId String
  url       String
  altAr     String @default("")
  altEn     String @default("")
  sortOrder Int    @default(0)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model ProductVariant {
  id        String   @id @default(cuid())
  productId String
  size      String
  cut       String   @default("standard")
  color     String   @default("default")
  sku       String   @unique
  stock     Int      @default(0)
  priceQar  Decimal  @db.Decimal(10, 2)
  priceSar  Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@map("product_variants")
}

// ─── Orders ─────────────────────────────────────────────────────────

model Order {
  id            String      @id @default(cuid())
  orderNumber   String      @unique
  status        OrderStatus @default(NEW)
  currency      Currency    @default(SAR)
  subtotal      Decimal     @db.Decimal(10, 2)
  discount      Decimal     @default(0) @db.Decimal(10, 2)
  discountCode  String?
  shippingFee   Decimal     @default(0) @db.Decimal(10, 2)
  total         Decimal     @db.Decimal(10, 2)
  country       Country     @default(SA)
  customerName  String
  phone         String
  email         String?
  customerNote  String?
  internalNote  String?
  paymentMethod String      @default("COD")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  items   OrderItem[]
  address OrderAddress?

  @@map("orders")
}

model OrderItem {
  id             String  @id @default(cuid())
  orderId        String
  productId      String?
  variantId      String?
  nameSnapshotAr String
  nameSnapshotEn String
  variantLabel   String?
  sku            String?
  imageSnapshot  String?
  qty            Int
  unitPrice      Decimal @db.Decimal(10, 2)
  lineTotal      Decimal @db.Decimal(10, 2)

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@map("order_items")
}

model OrderAddress {
  id         String  @id @default(cuid())
  orderId    String  @unique
  country    String
  city       String
  zone       String?
  street     String
  building   String?
  unit       String?
  postalCode String?
  notes      String?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_addresses")
}

// ─── Admin / RBAC ───────────────────────────────────────────────────

model AdminUser {
  id           String    @id @default(cuid())
  name         String
  email        String    @unique
  passwordHash String
  role         AdminRole @default(STAFF)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  rolePermissions RolePermission[]

  @@map("admin_users")
}

model Permission {
  id          String @id @default(cuid())
  key         String @unique
  description String @default("")

  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String @id @default(cuid())
  adminUserId  String
  permissionId String

  adminUser  AdminUser  @relation(fields: [adminUserId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([adminUserId, permissionId])
  @@map("role_permissions")
}

// ─── Store Settings ─────────────────────────────────────────────────

model StoreSettings {
  id              Int      @id @default(1)
  storeName       String   @default("Lamees")
  whatsappNumber  String   @default("+966501234567")
  shippingQarQA   Decimal  @default(0) @db.Decimal(10, 2)
  shippingSarSA   Decimal  @default(0) @db.Decimal(10, 2)
  freeShipAbove   Decimal  @default(500) @db.Decimal(10, 2)
  defaultCurrency Currency @default(SAR)
  vatPercent      Decimal  @default(15) @db.Decimal(5, 2)
  updatedAt       DateTime @updatedAt

  @@map("store_settings")
}
